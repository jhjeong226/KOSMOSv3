
{% extends "base.html" %}

{% block title %}CRNP Dashboard - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt me-2"></i>CRNP 관측소 대시보드
        </h1>
    </div>
</div>

<div class="row">
    {% for station_id in stations %}
    <div class="col-lg-6 col-xl-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i>{{ station_id }} 관측소
                </h5>
                <span class="badge bg-secondary status-badge" id="status-{{ station_id }}">
                    <i class="fas fa-spinner fa-spin"></i> 로딩중
                </span>
            </div>
            <div class="card-body">
                <div id="station-info-{{ station_id }}">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2 text-muted">상태 확인 중...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-group w-100" role="group">
                    <a href="/station/{{ station_id }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-chart-line me-1"></i>상세
                    </a>
                    <a href="/reports/{{ station_id }}" class="btn btn-success btn-sm" target="_blank">
                        <i class="fas fa-file-alt me-1"></i>리포트
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="generatePlots('{{ station_id }}')">
                        <i class="fas fa-sync me-1"></i>갱신
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not stations %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            사용 가능한 관측소가 없습니다. 먼저 데이터를 전처리해주세요.
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// 페이지 로드 시 모든 관측소 상태 확인
document.addEventListener('DOMContentLoaded', function() {
    {% for station_id in stations %}
    loadStationStatus('{{ station_id }}');
    {% endfor %}
});

async function loadStationStatus(stationId) {
    try {
        const response = await fetch(`/api/station/${stationId}/status`);
        const status = await response.json();
        
        updateStationCard(stationId, status);
    } catch (error) {
        console.error(`Error loading status for ${stationId}:`, error);
        document.getElementById(`status-${stationId}`).innerHTML = 
            '<i class="fas fa-exclamation-triangle"></i> 오류';
        document.getElementById(`status-${stationId}`).className = 'badge bg-danger status-badge';
    }
}

function updateStationCard(stationId, status) {
    const statusBadge = document.getElementById(`status-${stationId}`);
    const infoDiv = document.getElementById(`station-info-${stationId}`);
    
    // 전체 상태 결정
    let overallStatus = 'success';
    let statusText = '정상';
    let statusIcon = 'fas fa-check-circle';
    
    if (status.preprocessing.status !== 'completed' || 
        status.calibration.status !== 'completed' ||
        status.soil_moisture.status !== 'completed') {
        overallStatus = 'warning';
        statusText = '불완전';
        statusIcon = 'fas fa-exclamation-triangle';
    }
    
    statusBadge.innerHTML = `<i class="${statusIcon}"></i> ${statusText}`;
    statusBadge.className = `badge bg-${overallStatus} status-badge`;
    
    // 상세 정보 업데이트
    let infoHtml = `
        <div class="row g-2">
            <div class="col-6">
                <div class="metric-card">
                    <div class="metric-value text-primary">${status.preprocessing.fdr_records || 0}</div>
                    <div class="metric-label">FDR 레코드</div>
                </div>
            </div>
            <div class="col-6">
                <div class="metric-card">
                    <div class="metric-value text-info">${status.preprocessing.crnp_records || 0}</div>
                    <div class="metric-label">CRNP 레코드</div>
                </div>
            </div>
        </div>
        
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                최종 업데이트: ${status.last_updated || 'N/A'}
            </small>
        </div>
        
        <div class="mt-2">
            <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-primary" style="width: ${getProgressWidth(status)}%"></div>
            </div>
            <small class="text-muted">처리 완료도</small>
        </div>
    `;
    
    infoDiv.innerHTML = infoHtml;
}

function getProgressWidth(status) {
    let completed = 0;
    const total = 5; // preprocessing, calibration, soil_moisture, validation, visualization
    
    if (status.preprocessing.status === 'completed') completed++;
    if (status.calibration.status === 'completed') completed++;
    if (status.soil_moisture.status === 'completed') completed++;
    if (status.validation.status === 'completed') completed++;
    if (status.visualization.status === 'completed') completed++;
    
    return (completed / total) * 100;
}

async function generatePlots(stationId) {
    const button = event.target;
    const originalHtml = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>생성중';
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/station/${stationId}/generate_plots`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                include_validation: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`플롯 생성 완료! ${result.total_plots}개의 플롯이 생성되었습니다.`);
            loadStationStatus(stationId);
        } else {
            alert(`플롯 생성 실패: ${result.error}`);
        }
    } catch (error) {
        alert(`오류가 발생했습니다: ${error.message}`);
    } finally {
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}
</script>
{% endblock %}
    